name: Build and publish QuPath + OMERO plugin

on:
  workflow_dispatch:
    inputs:
      qupath_version:
        description: 'QuPath base image tag (quay.io/galaxy/qupath-headless)'
        required: false
        default: 'latest'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QUPATH_IMAGE_VERSION: ${{ github.event.inputs.qupath_version || 'latest' }}

    steps:
    - name: Get latest OMERO plugin release tag
      id: get_plugin
      uses: actions/github-script@v6
      with:
        script: |
          const owner='qupath', repo='qupath-extension-omero';
          try {
            const r = await github.rest.repos.getLatestRelease({owner, repo});
            return r.data.tag_name.replace(/^v/,'');
          } catch (e) {
            const r = await github.rest.repos.getCommit({owner, repo, ref:'main'});
            return r.data.sha.substring(0,7);
          }

    - name: Checkout plugin repo
      uses: actions/checkout@v4
      with:
        repository: qupath/qupath-extension-omero
        ref: ${{ steps.get_plugin.outputs.result }}
        path: plugin

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Build OMERO plugin jar
      run: |
        cd plugin
        ./gradlew clean assemble -x test || ./gradlew clean build -x test
        ls build/libs

    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Copy plugin jar into build context
      run: |
        cp plugin/build/libs/*.jar ./qupath-extension-omero.jar

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ghcr.io/lavlabinfrastructure/docker-qupath:${{ env.QUPATH_IMAGE_VERSION }}-${{ steps.get_plugin.outputs.result }}
        build-args: |
          QUPATH_IMAGE_VERSION=${{ env.QUPATH_IMAGE_VERSION }}
          OMERO_PLUGIN_VERSION=${{ steps.get_plugin.outputs.result }}

    - name: Create GitHub release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ env.QUPATH_IMAGE_VERSION }}-${{ steps.get_plugin.outputs.result }}
        release_name: ${{ env.QUPATH_IMAGE_VERSION }}-${{ steps.get_plugin.outputs.result }}
        body: |
          Published image ghcr.io/lavlabinfrastructure/docker-qupath:${{ env.QUPATH_IMAGE_VERSION }}-${{ steps.get_plugin.outputs.result }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
