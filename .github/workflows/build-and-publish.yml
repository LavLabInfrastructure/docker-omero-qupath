name: Build and publish QuPath + OMERO plugin

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QUPATH_IMAGE_VERSION: ${{ github.event.inputs.qupath_version || 'latest' }}

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Get latest QuPath base image tag
      id: get_qupath
      run: |
        resp=$(curl -s 'https://quay.io/api/v1/repository/galaxy/qupath-headless/tag/?onlyActiveTags=true&limit=100')
        echo "$resp" | jq -r '.tags[].name' | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' | sort -V | tail -n1 > /tmp/qtag || true
        if [ -s /tmp/qtag ]; then echo "tag=$(cat /tmp/qtag)" >> $GITHUB_OUTPUT; else echo "tag=latest" >> $GITHUB_OUTPUT; fi

    - name: Get latest OMERO plugin release info
      id: get_plugin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        owner=qupath
        repo=qupath-extension-omero
        api="https://api.github.com/repos/$owner/$repo/releases/latest"
        resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$api")
        tag=$(echo "$resp" | jq -r '.tag_name' | sed 's/^v//' )
        # pick a single jar asset that is not a sources or javadoc jar
        asset_url=$(echo "$resp" | jq -r '.assets[]? | select((.name|test("\\.jar$")) and (.name|test("sources")|not) and (.name|test("javadoc")|not)) | .browser_download_url' | head -n1 || true)
        if [ "$tag" = "null" ] || [ -z "$tag" ]; then
          sha=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$owner/$repo/commits/main" | jq -r '.sha' | cut -c1-7)
          tag=$sha
          asset_url=''
        fi
        echo "tag=$tag" >> $GITHUB_OUTPUT
        echo "asset_url=$asset_url" >> $GITHUB_OUTPUT

    - name: Download plugin jar from release assets
      if: steps.get_plugin.outputs.asset_url != ''
      run: |
        echo "Downloading plugin from ${{ steps.get_plugin.outputs.asset_url }}"
        curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o qupath-extension-omero.jar "${{ steps.get_plugin.outputs.asset_url }}"

    - name: Setup Java (for plugin build)
      if: steps.get_plugin.outputs.asset_url == ''
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Build OMERO plugin jar (fallback)
      if: steps.get_plugin.outputs.asset_url == ''
      run: |
        echo "No jar asset found; checking out and building plugin"
        git clone --depth 1 https://github.com/qupath/qupath-extension-omero.git plugin || true
        cd plugin
        git checkout "${{ steps.get_plugin.outputs.tag }}" || true
        ./gradlew clean assemble -x test || ./gradlew clean build -x test
        ls build/libs || true
        cp build/libs/*.jar ../qupath-extension-omero.jar || true

    - name: Ensure plugin jar in build context
      run: |
        if [ -f qupath-extension-omero.jar ]; then echo "plugin jar already present"; else cp plugin/build/libs/*.jar ./qupath-extension-omero.jar || true; fi

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pin QuPath base image in Dockerfile
      run: |
        echo '--- Dockerfile before pinning ---'
        sed -n '1,120p' Dockerfile || true
        sed -i.bak -E "s|FROM quay.io/galaxy/qupath-headless:.*|FROM quay.io/galaxy/qupath-headless:${{ steps.get_qupath.outputs.tag }}|" Dockerfile
        echo '--- Dockerfile after pinning ---'
        sed -n '1,120p' Dockerfile || true

    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ghcr.io/lavlabinfrastructure/docker-qupath:${{ steps.get_qupath.outputs.tag }}-${{ steps.get_plugin.outputs.tag }}
        build-args: |
          OMERO_PLUGIN_VERSION=${{ steps.get_plugin.outputs.tag }}

    - name: Create GitHub release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ steps.get_qupath.outputs.tag }}-${{ steps.get_plugin.outputs.tag }}
        release_name: ${{ steps.get_qupath.outputs.tag }}-${{ steps.get_plugin.outputs.tag }}
        body: |
          Published image ghcr.io/lavlabinfrastructure/docker-qupath:${{ steps.get_qupath.outputs.tag }}-${{ steps.get_plugin.outputs.tag }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
